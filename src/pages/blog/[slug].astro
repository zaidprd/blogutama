---
// Import necessary components and utilities
import MainLayout from "@/layouts/MainLayout.astro";
import AvatarBlogLarge from "@components/ui/avatars/AvatarBlogLarge.astro";
import CardRelated from "@components/ui/cards/CardRelated.astro";
import Bookmark from "@components/ui/buttons/Bookmark.astro";
import SocialShare from "@components/ui/buttons/SocialShare.astro";
import PostFeedback from "@components/ui/feedback/PostFeedback.astro";
import { capitalize, formatDate } from "@utils/utils";

// Mengimpor fungsi spesifik dari Sanity
import { getPostAndRelated, getAllPostSlugs, type SanityPost } from '@/lib/sanity';
import { SITE } from "@data/constants";

// ðŸ‘‡ PERBAIKAN 1: Impor komponen Portable Text Renderer
import SanityContentRenderer from "@components/SanityContentRenderer.jsx"; 

// -------------------------------------------------------------
// 1. getStaticPaths: Mengambil semua slug dari Sanity
// -------------------------------------------------------------
export async function getStaticPaths() {
Â  const slugs = await getAllPostSlugs();
Â  return slugs.map(entry => ({
Â  Â  params: { slug: entry.slug },
Â  }));
}

// -------------------------------------------------------------
// 2. Mengambil data post berdasarkan slug
// -------------------------------------------------------------
const { slug } = Astro.params;
const { post, relatedPosts } = await getPostAndRelated(slug);

// Jika post tidak ditemukan (404)
if (!post) {
Â  Â  return Astro.redirect('/404', 404);
}

// -------------------------------------------------------------
// 3. Variabel Halaman (Menggunakan data Sanity)
// -------------------------------------------------------------
const pageTitle: string = `${post.title} | ${SITE.title}`;
const metaDescription: string = post.excerpt || `Read ${post.title} on ScrewFast's blog`; 
const ogTitle = `${post.title} | Blog | ${SITE.title}`;
// Hapus `postContent` simulasi karena kita akan menggunakan post.body secara langsung.
---

<MainLayout
Â  title={pageTitle}
Â  customDescription={metaDescription}
Â  customOgTitle={ogTitle}
Â  structuredData={{
Â  Â  "@context": "https://schema.org",
Â  Â  "@type": "BlogPosting",
Â  Â  headline: post.title,
Â  Â  // Menggunakan URL Sanity
Â  Â  image: post.imageUrl,
Â  Â  datePublished: post.pubDate,
Â  Â  author: {
Â  Â  Â  "@type": "Person",
Â  Â  Â  name: post.authorName,
Â  Â  },
Â  Â  publisher: {
Â  Â  Â  "@type": "Organization",
Â  Â  Â  name: SITE.title,
Â  Â  Â  logo: {
Â  Â  Â  Â  "@type": "ImageObject",
Â  Â  Â  Â  url: "https://screwfast.uk/favicon.ico",
Â  Â  Â  },
Â  Â  },
Â  Â  mainEntityOfPage: {
Â  Â  Â  "@type": "WebPage",
Â  Â  Â  "@id": `https://screwfast.uk/blog/${post.slug}`,
Â  Â  },
Â  }}
>
Â  <section class="mx-auto max-w-3xl px-4 pt-6 pb-12 sm:px-6 lg:px-8 lg:pt-10">
Â  Â  <div class="max-w-2xl">
Â  Â  Â  <div class="mb-6 flex items-center justify-between">
Â  Â  Â  Â  <div class="flex w-full gap-x-5 sm:items-center sm:gap-x-3">
Â  Â  Â  Â  Â  <AvatarBlogLarge post={post} />
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between gap-x-2">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-neutral-700 dark:text-neutral-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {post.authorName}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="text-xs text-neutral-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <li
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="relative inline-block pe-6 before:absolute before:end-2 before:top-1/2 before:size-1 before:-translate-y-1/2 before:rounded-full before:bg-neutral-300 last:pe-0 last-of-type:before:hidden dark:text-neutral-400 dark:before:bg-neutral-600"
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {formatDate(new Date(post.pubDate))}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <li
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="relative inline-block pe-6 before:absolute before:end-2 before:top-1/2 before:size-1 before:-translate-y-1/2 before:rounded-full before:bg-neutral-300 last:pe-0 last-of-type:before:hidden dark:text-neutral-400 dark:before:bg-neutral-600"
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {post.readTime || 5} min read
Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  {/* Blog post title */}
Â  Â  Â  <h2
Â  Â  Â  Â  class="mb-3 text-2xl font-bold text-neutral-800 md:text-3xl dark:text-neutral-200"
Â  Â  Â  >
Â  Â  Â  Â  {post.title}
Â  Â  Â  </h2>
Â  Â  Â  
Â  Â  Â  {/* ðŸ‘‡ PERBAIKAN 2: Render Gambar Utama sebelum konten Portable Text */}
Â  Â  Â  {post.imageUrl && (
Â  Â  Â  Â  <img
Â  Â  Â  Â  Â  class="w-full rounded-xl object-cover mb-8"
Â  Â  Â  Â  Â  src={post.imageUrl}
Â  Â  Â  Â  Â  alt={post.imageAlt || post.title}
Â  Â  Â  Â  Â  draggable={"false"}
Â  Â  Â  Â  Â  width={1200}
Â  Â  Â  Â  Â  height={675}
Â  Â  Â  Â  />
Â  Â  Â  )}
Â  Â  Â  
Â  Â  Â  {/* ðŸ‘‡ PERBAIKAN 3: Ganti simulasi konten dengan Portable Text Renderer */}
Â  Â  Â  <div class="mb-5 space-y-5 md:mb-8 md:space-y-8">
Â  Â  Â  Â  {/* ðŸ›‘ GUNAKAN KOMPONEN REACT DENGAN DIREKTIF KLIEN ðŸ›‘ */}
Â  Â  Â  Â  {post.body && <SanityContentRenderer body={post.body} client:load />}
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <div
Â  Â  Â  Â  class="mx-auto grid max-w-[--breakpoint-lg] gap-y-5 sm:flex sm:items-center sm:justify-between sm:gap-y-0"
Â  Â  Â  >
Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  class="flex flex-wrap gap-x-2 gap-y-1 sm:flex-nowrap sm:items-center sm:gap-y-0"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  post.tags?.map((tag: string) => (
Â  Â  Â  Â  Â  Â  Â  <span class="inline-flex items-center gap-x-1.5 rounded-lg bg-neutral-400/30 px-3 py-1.5 text-xs font-medium text-neutral-700 outline-hidden focus:outline-hidden focus-visible:ring-3 focus-visible:outline-hidden dark:bg-neutral-700/60 dark:text-neutral-300">
Â  Â  Â  Â  Â  Â  Â  Â  {capitalize(tag)}
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  ))
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  </div>
Â  Â  Â  Â  {/* Bookmark and Share buttons */}
Â  Â  Â  Â  <div class="flex items-center justify-end gap-x-1.5">
Â  Â  Â  Â  Â  <Bookmark />
Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  class="mx-3 block h-4 border-e border-neutral-400 dark:border-neutral-500"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="inline-flex">
Â  Â  Â  Â  Â  Â  <SocialShare pageTitle={post.title} />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <PostFeedback
Â  Â  Â  title="Was this post helpful?"
Â  Â  Â  firstChoice="Yes"
Â  Â  Â  secondChoice="No"
Â  Â  />
Â  </section>

Â  {/* Related articles section */}
Â  <section class="mx-auto max-w-3xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
Â  Â  <div class="mb-10 max-w-2xl">
Â  Â  Â  <h2
Â  Â  Â  Â  class="text-2xl font-bold text-balance text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
Â  Â  Â  >
Â  Â  Â  Â  Related articles
Â  Â  Â  </h2>
Â  Â  </div>

Â  Â  <div class="grid grid-cols-2 gap-6">
Â  Â  Â  {relatedPosts.map((post) => <CardRelated post={post} />)}
Â  Â  </div>
Â  </section>
</MainLayout>